# 需求变更记录（2026-01-13）

> 本文件用于记录本次“需求变更”落地到代码/接口/数据结构后的关键差异点，便于评审与回溯；详细接口以 `backend/API.md` 为准。

## 变更点概览

1. 孩子：新增 `parentIdentity`（爸爸/妈妈/奶奶/爷爷/外公/外婆），创建/更新孩子时必填。
2. Banner：新增 Banner 管理（标题/封面图/HTML 富文本/上架下架/顺序/软删），且最多仅允许 5 个 Banner 上架；小程序端支持轮播与点击进入富文本渲染页。
3. 上传：新增运营端统一上传接口（后端转存阿里云 OSS，返回可访问 URL），用于 Banner 封面与富文本媒体（图/音/视频）。
4. 鸡汤语：新增 `scene + minAge + maxAge` 字段；小程序端按“场景 + 孩子周岁”随机取 1 条（无数据返回 `data=[]`）。
5. 烦恼场景：新增烦恼场景模块（名称唯一、logo、最小/最大年龄、软删）；题库题目可多选关联烦恼场景；导入题目支持按名称匹配烦恼场景。
6. 育儿状态：新增按天记录（10 选 1），用户+孩子+日期唯一，可补录可修改不可删除。
7. 每日烦恼记录：新增按天记录（可多选烦恼场景），用户+孩子+日期唯一，可补录可修改不可删除，提交时至少选择 1 个场景。
8. 每日自测：选题优先使用“今日烦恼记录 + 年龄”匹配题目；做题数从固定 5 题改为 5~10 题（做满 5 题后可随时提交，最多 10 题）；换题排除本次会话已选/换过题。

## 数据库变更（DDL 基线）

- 变更文件：`backend/db/schema.sql`
- 新增/修改要点：
  - `child.parent_identity`
  - 新增表：`banner`、`trouble_scene`、`daily_parenting_status`、`daily_trouble_record`、`daily_trouble_record_scene`、`question_trouble_scene`
  - `quote` 新增：`scene`、`min_age`、`max_age`

> 注意：当前仓库使用 `schema.sql` 作为基线 DDL；若线上/已有数据库已存在旧表，需要按实际环境做增量迁移（`ALTER TABLE ...`）。

## 接口变更（摘要）

- 以 `backend/API.md` 为准，新增：
  - Admin：Banner、烦恼场景、上传接口
  - Miniprogram：Banner 列表/详情、烦恼场景列表、每日烦恼记录、每日育儿状态
- 变更：
  - Miniprogram 鸡汤语接口：`GET /miniprogram/quotes/random` 改为必须传 `childId + scene`，无数据返回 `[]`
  - Admin 鸡汤语新增/更新：需传 `scene + minAge + maxAge`
  - Admin 题库新增/更新：支持 `troubleSceneIds`
  - Admin 题库导入：包含烦恼场景名称时必须完全匹配；任一错误整体失败
