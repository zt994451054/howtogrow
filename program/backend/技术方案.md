# 后端技术方案（Spring Boot + MySQL + Spring AI）

> 范围：后端 API、鉴权、核心业务规则（出题/换题/计分/统计/权益）、运营端后台接口、OpenAPI/ApiFox、AI 总结与实时对话。

## 1. 技术栈
- Java 21（建议）+ Spring Boot 4.x（按草案要求）
- Spring Web（REST）
- Spring Security（JWT 鉴权，区分小程序与运营端）
- Spring AI（AI 自测总结、AI 实时对话）
- MySQL 8.0（主数据存储）
- OpenAPI：`springdoc-openapi`（导出给 ApiFox）
- 文件处理：Excel 导入（Apache POI）
- 支付：微信支付（微信商户，建议 WeChat Pay v3，小程序 JSAPI）

> 可选增强：Redis（限流/会话短期缓存/分布式锁），MVP 可先不引入，但多实例部署时建议纳入规划。

## 2. 工程与分层建议

### 2.1 模块边界
- `miniprogram` 接口：面向家长，资源以 `user_id` 进行强隔离
- `admin` 接口：面向运营，RBAC 权限校验
- `ai` 能力：仅作为“编排层”，提示词与输入输出约束由后端统一控制

### 2.2 分层（建议）
- `controller`：参数校验、鉴权信息提取、DTO 映射
- `application/service`：业务用例（每日自测、生成总结、导入题库、下单等）
- `domain`：核心规则（出题/换题/计分），尽量纯函数便于测试
- `infrastructure`：DB/第三方（微信、支付、模型网关）、文件解析、缓存

## 3. 鉴权与安全

### 3.1 JWT 约定
- 小程序端 token：`aud=miniprogram`
- 运营端 token：`aud=admin`
- token 统一用 `Authorization: Bearer <jwt>` 传递
- 关键接口必须做“资源归属校验”：例如 `child.user_id == jwt.sub`

### 3.2 微信登录流程（小程序）
1. 小程序调用 `wx.login()` 获取 `code`
2. 后端使用微信小程序密钥换取 `openid`（密钥通过环境变量注入）
3. 若用户不存在则创建用户，返回 JWT

> 注意：手机号获取/解密（如采用）同样只通过服务端与密钥完成，日志不得记录手机号明文。

### 3.3 微信支付（商户）安全要点
- 使用微信支付 v3：验签（平台证书）、解密回调资源（API v3 Key）、幂等处理（事件/订单唯一键）
- 不在数据库与日志中保存私钥/密钥明文；私钥以文件挂载或密钥管理注入
- 回调处理必须可重复执行：以 `order_no` + “发放记录唯一约束”保证订阅发放幂等

## 4. 核心业务规则落地（后端视角）

### 4.0 年龄段（整数年龄）
- 题库直接使用“整数年龄范围（岁，含边界）”：`question.min_age` / `question.max_age`
- 不再单独维护年龄段配置表；出题时按孩子整数年龄匹配题库（`min_age <= age <= max_age`）

### 4.1 每日自测：创建、换题、提交

**开始做题（begin，不落库）**
- 输入：`childId`
- 校验：孩子归属、当日是否已完成（北京时间口径，提交前查询已提交记录拦截）
- 出题：按孩子整数年龄（岁）匹配题库，从符合范围的题库随机抽取 5 题（题目不重复）
- 输出：会话 ID、5 道题与选项
- 缓存：后端使用 Redis 记录“本会话已给出的题目”用于换题判重（key：`userId+childId+timestamp`）

**换题（replace，基于会话）**
- 输入：`sessionId + childId + displayOrder`
- 规则：被换掉题目不再参与本次自测；新题从“未出现过且符合年龄（岁）”的题库中随机抽取
- 题库耗尽：返回明确业务错误码（如 `QUESTION_POOL_EXHAUSTED`）

**提交（submit，整体提交一次性落库）**
- 输入：`sessionId + childId + 5 题完整答案`（多选允许多个 optionId）
- 事务内校验：
  - 会话有效，且答案必须覆盖当前 5 题
  - option 必须属于该题
  - 当日唯一性：北京时间口径（按 `submitted_at` 日期）不允许重复提交
- 计分明细：按“选项-维度分值”将每个作答选项在各维度的分值写入 `daily_assessment_dimension_score`（明细表）
- 落库：仅在提交成功后插入 `daily_assessment(submitted_at)` + 5 条 `daily_assessment_item` + 作答与得分明细

### 4.2 AI 自测总结
- 权限：仅订阅用户可用
- 次数：每条自测记录最多生成 1 次（数据库唯一约束保证）
- 输入：本次题目与作答、维度得分、孩子年龄/性别；**不带历史数据**
- 输出：≤70 字，共情、正向引导，不包含诊断/评判语
- 模型：通过 OpenAI 兼容接口接入（`AI_BASE_URL/AI_API_KEY/AI_MODEL` 配置注入）

### 4.3 AI 实时对话
- 权限：仅订阅用户可用
- 上下文：按会话取最近 N 条消息（例如 20 条）作为上下文；不做跨会话/跨天记忆
- 传输：使用 SSE（Server-Sent Events）流式输出即可
- 模型：通过 OpenAI 兼容接口接入，建议开启流式输出以提升交互体验

### 4.4 订阅购买与发放（微信支付）
**下单**
- 小程序选择套餐 → `POST /api/v1/miniprogram/subscriptions/orders`
- 后端创建 `purchase_order`（`order_no` 全局唯一）并调用微信“下单”接口获取 `prepay_id`
- 后端返回给小程序 `wx.requestPayment` 所需参数（由后端签名）

**支付回调**
- 微信支付回调 `POST /api/v1/pay/wechat/notify`
- 后端验签 + 解密资源，校验 `out_trade_no`、金额与订单一致
- 状态流转：`CREATED -> PAID`（不支持退款），并生成一条 `subscription_grant`（对 `order_id` 唯一）作为“发放幂等锚点”
- **生效时间**：以微信支付交易的“支付成功时间（success_time）”作为 `paid_at/granted_from`
- 更新用户 `subscription_end_at`：按“到期时间与 `paid_at` 取 max，再加套餐天数”计算
- 交易流水：回调解密后将关键字段写入 `wechat_pay_transaction`，用于运营查询与对账（与订单 1:1）

## 5. OpenAPI/ApiFox 对接
- 约定开启：
  - OpenAPI JSON：`/v3/api-docs`
  - Swagger UI：`/swagger-ui.html`（或框架默认路径）
- ApiFox 导入：下载 `OpenAPI 3.x` JSON 后导入（或提供可访问的 URL）
- 组织方式：按 Tag 区分 `Miniprogram-*`、`Admin-*`、`AI-*`

## 6. 数据库设计（MySQL 8.0）

### 6.1 设计原则
- 以 `user_id` 作为隔离边界（孩子、自测、会话、订单等表均带 `user_id`）
- 关键业务使用唯一索引兜底：每日自测、AI 总结、订单号等
- 软删除：运营误删可恢复，且不影响历史统计

### 6.2 DDL
- 初始化 DDL：`program/backend/db/schema.sql`

## 7. API（字段级草案，MVP）

> 说明：这里是便于前后端对齐的字段级约定，最终以 OpenAPI 为准。

### 7.1 通用响应
```json
{ "code": "OK", "message": "ok", "data": {}, "traceId": "..." }
```

### 7.2 小程序端

#### 7.2.1 登录
`POST /api/v1/miniprogram/auth/wechat-login`
- 请求：`{ "code": "wx_login_code" }`
- 响应：
  - `token`: string
  - `expiresIn`: number（秒）
  - `user`: `{ id, nickname, avatarUrl, subscriptionEndAt, freeTrialUsed }`

#### 7.2.2 孩子管理
`POST /api/v1/miniprogram/children`
- 请求：`{ "nickname": "...", "gender": 0|1|2, "birthDate": "YYYY-MM-DD" }`
- 响应：`{ "childId": 1 }`

`PUT /api/v1/miniprogram/children/{childId}`
- 请求：`{ "nickname": "...", "gender": 0|1|2, "birthDate": "YYYY-MM-DD" }`

`DELETE /api/v1/miniprogram/children/{childId}`

#### 7.2.3 每日自测
`POST /api/v1/miniprogram/assessments/daily/begin`
- 请求：`{ "childId": 1 }`
- 响应：
  - `sessionId`: string
  - `items`: `[{ displayOrder, questionId, content, questionType, options: [{ optionId, content, sortNo }] }]`

`POST /api/v1/miniprogram/assessments/daily/sessions/{sessionId}/replace`
- 请求：`{ "childId": 1, "displayOrder": 1 }`
- 响应：`{ "displayOrder": 1, "newItem": { ...同 begin.items 单项... } }`

`POST /api/v1/miniprogram/assessments/daily/sessions/{sessionId}/submit`
- 请求：
  - `childId`: number
  - `answers`: `[{ "questionId": 1, "optionIds": [1,2] }]`（必须覆盖当前 5 题）
- 响应：
  - `assessmentId`: number
  - `dimensionScores`: `[{ dimensionCode, dimensionName, score }]`（后端对明细聚合后的结果）

#### 7.2.4 AI 自测总结（≤70字）
`POST /api/v1/miniprogram/assessments/daily/{assessmentId}/ai-summary`
- 响应：`{ "content": "..." }`

#### 7.2.5 AI 实时对话
`POST /api/v1/miniprogram/ai/chat/sessions`
- 请求：`{ "childId": 1 }`（可选）
- 响应：`{ "sessionId": 1 }`

`POST /api/v1/miniprogram/ai/chat/sessions/{sessionId}/messages`
- 请求：`{ "content": "..." }`
- 响应：`{ "messageId": 1 }`

`GET /api/v1/miniprogram/ai/chat/sessions/{sessionId}/stream`（SSE）
- 用途：按会话输出增量内容（建议事件：`delta`/`done`/`error`）
- 说明：客户端发完 `messages` 后再订阅该会话的 `stream` 获取本次 assistant 的流式内容

#### 7.2.6 订阅与支付
`GET /api/v1/miniprogram/subscriptions/plans`
- 响应：`[{ planId, name, days, priceCent }]`

`POST /api/v1/miniprogram/subscriptions/orders`
- 请求：`{ "planId": 1 }`
- 响应：
  - `orderNo`: string
  - `payParams`: `{ timeStamp, nonceStr, package, signType, paySign }`（直接给 `wx.requestPayment`）

`POST /api/v1/pay/wechat/notify`（微信回调）
- 响应：`{ "code": "SUCCESS", "message": "OK" }`

### 7.3 运营端（Admin）
`POST /api/v1/admin/auth/login`
- 请求：`{ "username": "...", "password": "..." }`
- 响应：`{ "token": "...", "expiresIn": 3600 }`

`POST /api/v1/admin/questions/import-excel`
- 请求：`multipart/form-data`（字段：`file`）
- 响应：`{ "total": 100, "success": 98, "failed": 2, "failures": [{ "row": 12, "reason": "..." }] }`

## 8. Excel 导入模板（问题集）

### 8.1 模板列（建议）
- 一个 sheet：`题库导入`；表头见 `program/backend/db/question-import-template.xlsx`
- 一行 = 一个选项；同一“问题”有多个选项则复制多行
- 用户不需要填写技术字段（如 code / sort）；后端负责转换与生成
- 表头（中文）：
  - `问题`
  - `问题类型（单选/多选）`（可空，默认多选；后端转换为 `SINGLE/MULTI`）
  - `适用最小年龄`（整数，必填，单位：岁，含边界）
  - `适用最大年龄`（整数，必填，单位：岁，含边界）
  - `选项值`（必填）
  - `选项标识（建议/不建议）`（必填；后端转换为 `suggest_flag`）
  - `改进文案`（可选）
  - 五个维度分值列（正整数；空表示不命中该维度）：
    - `情绪管理力分值`
    - `沟通表达力分值`
    - `规则引导力分值`
    - `关系建设力分值`
    - `学习支持力分值`

### 8.2 校验规则（建议）
- `适用最小年龄/适用最大年龄` 必须为整数，且建议在合理范围内（如 `0..18`），并满足 `最小年龄 <= 最大年龄`
- 五个维度分值列：必须为正整数；至少填写 1 个维度分值
- `选项标识`：建议/不建议（如出现“正确”，后端按“建议”处理）
- 排序：后端按 Excel 行顺序在同一题内生成 `sort_no`

## 9. 业务错误码（建议）
- `OK`
- `UNAUTHORIZED`
- `FORBIDDEN_RESOURCE`
- `SUBSCRIPTION_REQUIRED`
- `FREE_TRIAL_ALREADY_USED`
- `DAILY_ASSESSMENT_ALREADY_SUBMITTED`
- `DAILY_ASSESSMENT_INCOMPLETE`
- `QUESTION_POOL_EXHAUSTED`
- `AI_SUMMARY_ALREADY_GENERATED`
- `WECHAT_PAY_VERIFY_FAILED`
- `WECHAT_PAY_AMOUNT_MISMATCH`
- `ORDER_ALREADY_PAID`

## 10. 配置项（环境变量建议）
- MySQL：`MYSQL_HOST`、`MYSQL_PORT`、`MYSQL_DATABASE`、`MYSQL_USERNAME`、`MYSQL_PASSWORD`
- JWT：`JWT_SECRET_MINIPROGRAM`、`JWT_SECRET_ADMIN`
- 微信小程序：`WECHAT_APPID`、`WECHAT_SECRET`
- 微信支付：`WECHAT_PAY_MCH_ID`、`WECHAT_PAY_MCH_SERIAL_NO`、`WECHAT_PAY_API_V3_KEY`、`WECHAT_PAY_PRIVATE_KEY_PATH`、`WECHAT_PAY_NOTIFY_URL`
- AI（OpenAI 兼容）：`AI_BASE_URL`、`AI_API_KEY`、`AI_MODEL`

### 10.1 本地开发环境（已确认）
- MySQL：`localhost:3306`
- 用户名/密码：`root` / `123456`
- 数据库：`howtotalk`


### 7.1 小程序端（示例）
- `POST /api/v1/miniprogram/auth/wechat-login`
- `GET /api/v1/miniprogram/me`
- `POST /api/v1/miniprogram/children`
- `GET /api/v1/miniprogram/children`
- `POST /api/v1/miniprogram/assessments/daily/begin`
- `POST /api/v1/miniprogram/assessments/daily/sessions/{sessionId}/replace`
- `POST /api/v1/miniprogram/assessments/daily/sessions/{sessionId}/submit`
- `POST /api/v1/miniprogram/assessments/daily/{assessmentId}/ai-summary`
- `GET /api/v1/miniprogram/reports/growth?childId=...&from=YYYY-MM-DD&to=YYYY-MM-DD`
- `GET /api/v1/miniprogram/quotes/random`
- `GET /api/v1/miniprogram/subscriptions/plans`
- `POST /api/v1/miniprogram/subscriptions/orders`

### 7.2 运营端（示例）
- `POST /api/v1/admin/auth/login`
- `GET /api/v1/admin/users`
- `GET /api/v1/admin/users/{userId}/assessments`
- `GET /api/v1/admin/orders`
- `GET /api/v1/admin/questions`
- `POST /api/v1/admin/questions`
- `POST /api/v1/admin/questions/import-excel`
- `GET /api/v1/admin/subscription-plans`
- `POST /api/v1/admin/subscription-plans`

## 8. 关键业务错误码（建议）
- `DAILY_ASSESSMENT_ALREADY_SUBMITTED`
- `DAILY_ASSESSMENT_INCOMPLETE`
- `QUESTION_POOL_EXHAUSTED`
- `SUBSCRIPTION_REQUIRED`
- `AI_SUMMARY_ALREADY_GENERATED`
- `FORBIDDEN_RESOURCE`
