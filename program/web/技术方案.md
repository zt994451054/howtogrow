# PC Web 运营端技术方案（Vue）

> 范围：运营端后台（账号权限、用户/订单/自测记录查看、题库管理与 Excel 导入、套餐管理）。

## 1. 技术栈建议
- Vue 3 + TypeScript + Vite
- UI 框架：Element Plus（组件齐全、后台场景成熟）
- 路由：Vue Router
- 状态管理：Pinia
- 请求：Axios（统一拦截器：JWT、错误处理、分页参数）
- 表格导出/导入：前端只负责上传 Excel，解析与校验在后端完成

## 2. 页面与路由规划
- 登录：`/login`
- 布局：`/`（侧边栏 + 顶栏 + 面包屑）
- 用户管理：`/users`（列表、详情、权益/订阅信息）
- 自测记录：`/assessments`（查询、详情：题目/作答/维度得分）
- 订单管理：`/orders`
- 题库管理：
  - 问题：`/questions`
  - Excel 导入：`/questions/import`
- 套餐管理：`/plans`
- 鸡汤语管理：`/quotes`
- 运营账号/权限：`/admin/users`、`/admin/roles`、`/admin/permissions`

## 3. 鉴权与权限（RBAC）
- 登录成功后后端返回 JWT（`aud=admin`），前端存储在 `localStorage`（或更严格的内存+刷新策略）
- Axios 请求统一加 `Authorization: Bearer <jwt>`
- 前端路由守卫：
  - 无 token → 跳转登录
  - 有 token → 拉取当前用户与权限码，动态渲染菜单与按钮级权限
- 后端仍作为最终权限裁决者（前端只做展示控制）
  - 当前定案：后端只校验 JWT 合法性，不开启权限码强校验；`permissionCodes` 仅用于前端组件/菜单渲染（UI 级控制）

## 4. 交互与错误处理约定
- 统一响应结构：`code/message/data`（以通用方案为准）
- 全局错误：
  - `401`：清理 token，跳转登录
  - `403`：提示无权限
  - 业务码：按 `message` 友好提示（避免直接暴露堆栈）
- 列表查询：分页、排序、筛选参数统一封装（便于复用）

## 5. 订单口径（当前阶段）
- 不支持退款：订单以“创建/支付成功/取消（超时）”为主要状态
- 订阅生效时间以“支付成功时间”为准，前端展示以服务端返回为准

## 6. Excel 导入（问题集）
- 前端：仅上传文件（`multipart/form-data`），展示导入结果（成功/失败条数、失败原因）
- 后端：
  - 校验模板（必填列、枚举值、分值为正整数、维度码存在）
  - 单行失败不影响其他行（可配置“全量失败”策略）
  - 返回可下载的失败明细（可选）

## 7. 工程结构与约定（建议补充到落地阶段）
> 目的：尽量“模块化 + 低耦合”，让运营端页面按业务域拆分，API/类型/页面同目录，减少跨目录跳转。

### 7.1 推荐目录结构
```txt
src/
  api/                      # 通用 HTTP 客户端、拦截器、错误映射
  modules/                  # 按业务域拆分（用户、订单、题库、RBAC 等）
  router/                   # 路由定义与守卫（含动态路由）
  stores/                   # Pinia store（auth、me、permission 等）
  layouts/                  # 后台布局（侧边栏/顶栏/面包屑）
  components/               # 跨模块复用组件（表格壳、查询表单壳等）
  utils/                    # 纯工具函数（时间、格式化、校验）
```

### 7.2 代码风格与工程化（最低配）
- 统一 TypeScript 严格模式（避免 `any` 扩散）
- ESLint + Prettier（CI 里最少跑 lint，避免风格漂移）
- API 与页面：优先“薄页面 + 可复用的请求/表格逻辑”（组合式函数 `use*`）

## 8. API 设计落地（Web 侧约定）
### 8.1 API Base URL 策略（建议尽早定）
当前定案：支持跨域，前端直连后端域名。
- 前端：采用运行时 `config.js`（通过环境变量控制），避免“每个环境都要重建镜像”
  - 约定：Nginx 静态目录下提供 `/config.js`，内容为 `window.__APP_CONFIG__ = { apiBaseUrl: "..." }`
  - 启动时：容器用环境变量渲染生成 `config.js`（例如 `WEB_ENV` / `API_BASE_URL`），前端用 `window.__APP_CONFIG__.apiBaseUrl` 作为 API base
  - 页面加载：`index.html` 需要在应用脚本前加载 `config.js`（例如 `<script src="/config.js"></script>`），保证应用初始化时已拿到配置
- 后端：全接口开启 CORS（至少允许运营端域名、`Authorization` 头、以及常用方法；并正确响应 `OPTIONS` 预检）

说明：若你在后端配置“允许任意 Origin（`*`）”，需要避免与 `credentials=true` 冲突；更推荐通过环境变量配置允许的运营端域名列表（开发环境可放宽）。

Web 容器环境变量（当前仓库落地）：
- `WEB_ENV=dev|test|prod`：选择内置的 baseURL 方案（默认 `dev`）
- `BACKEND_PORT=8080`：当 `WEB_ENV=test|prod` 且未显式指定 `API_BASE_URL` 时，默认拼接为 `${location.protocol}//${location.hostname}:<BACKEND_PORT>`
- `API_BASE_URL`：可选，直接覆盖 `apiBaseUrl`（例如 `https://api.example.com`），优先级最高
  - `docker-compose` 外部变量名约定为 `WEB_API_BASE_URL`（容器内映射到 `API_BASE_URL`，见 `program/deploy/.env.example`）

可选（未来如需同域部署以减少 CORS 成本）：通过 Nginx 反向代理 `/api` 到后端容器（好处：避免 CORS、同一个镜像可跨环境复用）。
- 前端：`VITE_API_BASE_URL=/api`
- Nginx：将 `/api/` 代理到后端容器（如 `http://backend:8080`）

### 8.2 类型与接口同步（建议）
- 以 `springdoc-openapi` 输出的 OpenAPI 为单一事实源
- 可选：用 OpenAPI 生成 TypeScript 类型（避免前后端字段不一致），并把“接口变更”纳入提测门禁

### 8.3 响应/分页/错误码约定（Web 侧处理）
- 通用响应：`{ code, message, data, traceId }`
- 分页入参：`page`（1-based）、`pageSize`；出参：统一为 `{ items, total }`
- 业务错误码：按后端方案（例如 `AGE_GROUP_OVERLAP`、`QUESTION_POOL_EXHAUSTED`），前端做“可读提示文案”映射

分页响应示例（建议）：
```json
{ "code": "OK", "message": "ok", "data": { "items": [], "total": 0 }, "traceId": "..." }
```

## 9. RBAC 细化落地（建议补全）
> 目标：做到“路由级 + 菜单级 + 按钮级”三层一致，且任何情况下以后端为准。

### 9.1 权限码与路由 meta（建议约定）
- 权限码命名建议：`<RESOURCE>:<ACTION>`（例：`QUESTION:IMPORT`）。建议直接以数据库 `admin_permission.code` 作为唯一事实源。
- 路由 `meta`：
  - `requiresAuth: true`
  - `permission?: string`（路由级权限码）
  - `title: string`（面包屑/菜单）

### 9.2 权限加载与动态路由
- 登录成功后：`/api/v1/admin/auth/me` 拉取当前账号信息与权限码集合
- 根据权限码过滤“可见路由树/菜单树”，再注册动态路由（避免 UI 展示与实际权限不一致）
- 按钮级权限：提供 `v-permission="'QUESTION:MANAGE'"` 指令或 `hasPermission()` 工具方法

权限展示口径（当前定案）：
- 权限判断：只用 `admin_permission.code`
- 前端组件/菜单文案：按 `admin_permission.name`（或前端本地字典）展示与分组

### 9.4 `GET /api/v1/admin/auth/me` 响应契约（以 API.md 为准）
> 目的：前端只依赖这一个接口完成登录态恢复、权限拉取、菜单/路由渲染与按钮级控制；后续后端可增字段，但不随意改名/改结构。

`AdminMeResponse`（当前）：
- `adminUserId`: number
- `username`: string
- `permissionCodes`: string[]（权限码集合，例如 `QUESTION:IMPORT`）

前端若需要“按权限名称分组/展示”，建议调用 `GET /api/v1/admin/rbac/permissions` 获取 `{ code, name }` 列表并构建 `code -> name` 字典（或后端后续在 `auth/me` 里补充 `permissionNameMap` 以减少一次请求）。

### 9.5 权限码 -> 路由/按钮（当前阶段建议）
> 说明：当前 RBAC 按“资源范围”权限推进；管理类页面默认包含“新增/编辑/删除/启停用/排序调整”等操作（均视为 MANAGE）。

| permission code | 页面/路由 | 主要按钮/操作（示例） |
|---|---|---|
| `QUESTION:MANAGE` | `/questions` | 新增/编辑/启用停用/调整排序 |
| `QUESTION:IMPORT` | `/questions/import` | 上传导入 |
| `USER:READ` | `/users` | 查看列表/详情 |
| `ORDER:READ` | `/orders` | 查看列表/详情 |
| `ASSESSMENT:READ` | `/assessments` | 查看列表/详情 |
| `PLAN:MANAGE` | `/plans` | 新增/编辑/上下架 |
| `QUOTE:MANAGE` | `/quotes` | 新增/编辑/删除/上下架 |
| `RBAC:MANAGE` | `/admin/users` `/admin/roles` `/admin/permissions` | 新增/编辑/绑定角色权限 |

### 9.6 RBAC 相关 API（以 API.md 为准）
- `GET /api/v1/admin/rbac/permissions`（权限列表：用于构建 `code -> name` 映射）
- `GET /api/v1/admin/rbac/roles` / `POST /api/v1/admin/rbac/roles`
- `PUT /api/v1/admin/rbac/roles/{roleId}/permissions`
- `GET /api/v1/admin/rbac/admin-users` / `POST /api/v1/admin/rbac/admin-users`
- `PUT /api/v1/admin/rbac/admin-users/{adminUserId}/roles`

### 9.3 Token 存储策略（需明确）
当前定案：不做 refresh token，admin JWT 有效期 12 小时；过期后需要重新登录。
- 存储建议：`localStorage`（实现最简单；配合全局 `401` 处理清理 token 并跳转登录）
- 说明：权限变更/禁用账号的“立刻生效”依赖后端校验与 token 过期窗口；若未来需要“踢下线/立即生效”，再引入 refresh + 作废机制

## 10. 页面交互规范（建议补全）
### 10.1 列表页统一形态
- “查询表单 + 表格 + 分页”三段式
- 查询条件改变：重置到 `page=1`
- 统一空态、加载态、错误态（避免每页各写一套）

### 10.2 详情页与编辑页
- 详情页：只读信息优先服务端返回为准（订阅到期时间、订单状态、权限信息等）
- 编辑页：表单校验尽量前置（必填、范围、枚举），但仍以服务端校验为准

### 10.3 查询参数约定（当前定案）
> 适用范围：仅“查询类接口”（列表/搜索/统计查询）。非查询接口不使用这些参数。
> 推进策略：前端先统一按该约定发送；后端可逐步适配（未支持的参数可先忽略，但需要保持接口语义不变）。

- MVP：先不做筛选/排序/时间范围，仅跑通基础查询与列表渲染
  - 分页：`page`（1-based）、`pageSize`
- 预留（后端后续逐步适配）：
  - 排序：`sortBy=<field>`，可选 `sortOrder=ASC|DESC`（未传则按后端默认排序）
  - 时间口径：`Asia/Shanghai`，时间字符串使用 `YYYY-MM-DD HH:mm:ss`
  - 时间范围（推荐字段名）：`startTime` / `endTime`（开始 `00:00:00`，结束 `23:59:59`）

## 11. Excel 导入页面（落地建议）
- 提供模板下载入口（建议后端提供 `/api/v1/admin/questions/import-template` 或静态模板）
- 上传前校验：文件类型（`.xlsx`）、大小上限（当前定案 5MB）、单次只允许 1 个文件
- 导入结果：显示 `total/success/failed`，失败列表支持分页（失败很多时避免一次性渲染）
- 可选：失败明细文件下载（后端生成并返回下载链接或文件流）
当前定案：
- 不支持部分成功（要么全量成功，要么全量失败），因此后端需要先完成全量校验再入库（建议事务包裹）
- 前端失败提示：直接展示后端返回的 `message` / `failures.reason`（不做额外友好化映射）

## 12. 构建与部署（落地建议）
- 前端产物：静态文件（Nginx/任意静态服务器托管）
- 运行配置：通过运行时 `/config.js` 注入 `apiBaseUrl`（容器启动时由环境变量生成）
- 生产部署：与后端一起通过 `docker compose` 编排（示例见 `program/deploy/docker-compose.prod.yml`）

建议补充（与当前仓库状态相关）：
- 当前仓库已支持通过 `WEB_ENV` 选择 baseURL，并支持通过 `WEB_API_BASE_URL` 覆盖（见 `program/deploy/.env.example`）
- 若未来切换为“同域 + /api 反代”，可改为 `VITE_API_BASE_URL=/api`（构建期注入）并移除跨域依赖

### 12.1 Nginx 反代示例（可选，供落地时参考）
> 当你选择“同域 + /api 反代”时使用；若跨域直连则不需要这一段。
> 假设后端服务名为 `backend`，端口 `8080`（与 `program/deploy/docker-compose.prod.yml` 一致）。

```nginx
location /api/ {
  proxy_pass http://backend:8080;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Request-Id $request_id;
}

location /assets/ {
  expires 1y;
  add_header Cache-Control "public, max-age=31536000, immutable";
}
```

## 13. 已确认清单（便于开工对齐）
- API：支持跨域；前端采用运行时 `config.js`（环境变量渲染）注入 `apiBaseUrl`；后端全接口开启 CORS
- JWT：不做 refresh，admin token 12 小时过期
- RBAC：权限码先按 `schema.sql` 中 10 个资源范围权限推进（用 `code` 做判断，`name` 做展示）
  - 后端：不启用权限码强校验（只校验 JWT）；权限码仅用于前端渲染
- 列表：排序字段 `sortBy`（建议同时支持 `sortOrder=ASC|DESC`）
- 时间：`Asia/Shanghai`，`YYYY-MM-DD HH:mm:ss`，开始 `00:00:00` / 结束 `23:59:59`
- Excel：5MB 限制，不支持部分成功（全量校验通过才入库）
