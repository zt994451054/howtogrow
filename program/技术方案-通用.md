# 正向育儿自测与陪伴平台 — 通用技术方案（草案）

> 范围：面向「微信小程序端（家长）」与「PC Web 运营端」的整体技术方案，覆盖架构、鉴权、数据模型、AI 能力、CI/CD 与部署方式。
> 需求来源：`需求/1227 gpt梳理需求.md`、`技术/技术文档草案.txt`。

## 1. 目标与边界

### 1.1 目标
- 支持家长微信登录、孩子管理、每日自测、成长报告、订阅购买、AI 实时对话与 AI 自测总结
- 支持运营端账号与权限、问题集管理（含 Excel 导入）、用户/订单/自测记录查看、套餐管理
- 保证规则可复现：出题/换题/提交拦截/计分与统计均可追溯

### 1.2 非目标（当前阶段不做）
- 对孩子/家长进行诊断与标签化评判（产品原则）
- 跨会话长期记忆（AI 实时对话不做跨会话/跨天记忆）

## 2. 总体架构

### 2.1 组件划分
- **后端（Spring Boot）**：业务 API、鉴权、规则引擎（出题/计分/统计）、运营后台 API、AI 能力编排（Spring AI）
- **MySQL 8.0**：用户、孩子、题库、作答、计分、订单、订阅、运营权限、AI 会话与消息（仅会话级）
- **PC Web（Vue）**：运营后台（RBAC、Excel 导入、管理与统计）
- **微信小程序**：用户端（自测、报告、订阅、AI 对话）

### 2.2 关键数据流（摘要）
1. **微信登录**：小程序 `wx.login()` 获取 `code` → 后端换取 `openid/unionid`（密钥走环境变量）→ 生成用户 → 返回 **JWT**
2. **每日自测**：选择孩子 → 后端按年龄段随机 5 题并创建“当日自测草稿” → 客户端作答/换题 → 提交后端原子校验并落库计分
3. **AI 自测总结**：仅订阅用户，对“已提交自测”最多生成 1 次，后端基于本次题目+作答+维度得分调用 Spring AI，输出≤70字
4. **AI 实时对话**：仅订阅用户，按“会话”保留上下文；后端取该会话最近 N 条消息拼接上下文 → Spring AI 流式输出
5. **订阅支付**：小程序选择套餐 → 后端微信支付下单 → 返回 `wx.requestPayment` 参数 → 微信回调 → 后端验签/幂等发放订阅
6. **运营端**：用户名/密码登录 → JWT → RBAC 校验 → 题库管理/Excel 导入/用户与订单查询

## 3. 技术栈与约束

### 3.1 后端
- **Spring Boot 4.x**（按草案要求；若落地时 4.x 生态未满足可用性，可回退到 3.x 并保持接口/结构不变）
- **Spring AI**：实现 AI 实时对话与 AI 自测总结（模型提供方使用 OpenAI 兼容接口或私有大模型网关，均用配置注入）
- **OpenAPI**：后端生成 OpenAPI 文档（便于导入 ApiFox）
- **JWT**：小程序端与运营端统一 JWT 鉴权（建议区分 `aud` 或 `token_type`）

### 3.2 前端
- **PC Web：Vue 3 + TypeScript + UI 框架（建议 Element Plus）**
- **微信小程序**：原生小程序（可选 TypeScript）+ UI 组件库（建议 Vant Weapp）

### 3.3 数据库
- **MySQL 8.0**，统一 `utf8mb4`，重要表包含 `created_at/updated_at` 与软删除字段（如 `deleted_at` 或 `is_deleted`）

## 4. 鉴权与权限模型（JWT）

### 4.1 JWT 载荷建议
- `sub`: 用户 ID / 管理员 ID
- `aud`: `miniprogram` | `admin`
- `exp/iat/nbf`
- 可选：`role_codes`（运营端）或 `scope`

### 4.2 权限模型
- 小程序端：以用户为边界，所有资源必须校验 `user_id` 一致（用户数据、孩子、自测、会话等）
- 运营端：RBAC（角色-权限-资源），后端接口按权限码控制

## 5. 业务规则落地要点

### 5.1 每日自测（强一致）
- **唯一性约束**：北京时间口径，`user_id + child_id + 当天` 仅允许一条“已提交”记录（提交前查询拦截；必要时可再加 DB 唯一约束兜底）
- **提交拦截**：仅当 5 题完整提交成功后才“消耗当日次数”
- **换题**：被换掉题目不再参与本次自测，补题从剩余题库随机抽取；题库耗尽需可判定并返回明确错误码

### 5.2 计分与成长报告
- 计分为“选项→维度分值”直接求和，不做归一化
- 成长报告按天聚合：对完成自测日期集合做“维度日均分趋势”

### 5.3 订阅与权益
- 首次注册：允许“1 个孩子免费体验 1 次每日自测”（不含 AI 对话与 AI 自测总结）
- 订阅用户：每日自测 + AI 对话 + AI 自测总结
- 多次购买：订阅天数累加（以数据库事务更新订阅到期时间）
- 不支持退款：订单状态机以 `CREATED -> PAID` 为主，订阅生效以“支付成功时间”为准

### 5.4 年龄段（整数年龄）
- 题库按“整数年龄范围（岁）”标注：`question.min_age` / `question.max_age`（含边界）
- 不再单独维护年龄段配置表；出题时按孩子整数年龄匹配题库（`min_age <= age <= max_age`）

## 6. 数据模型（概要）

核心实体与关系：
- 用户（家长）1:N 孩子
- 题库：能力维度、问题、选项、选项-维度分值
- 自测：自测记录（按天/孩子）1:N 自测题目 1:N 作答选项；自测记录 1:N 维度得分
- 订阅：套餐、订单、用户订阅（到期时间）
- 运营端：管理员、角色、权限
- AI：会话、消息、总结（与自测记录 1:1）

（详细 DDL 见后端技术方案文档与 `program/backend/db/schema.sql`）

### 6.1 Schema 表关系说明
- 表关系说明文件：`program/backend/db/schema-关系说明.md`
- 用途：
  - 研发：对齐实体边界与 1:1 / 1:N / N:N 关系，减少接口与查询歧义
  - 运营/数据：快速定位“某功能对应哪些表”，便于排查与统计口径沟通
  - 审计：支付回调事件与交易流水的留存范围与用途可追溯

## 7. API 设计约定（通用）
- 前缀：`/api/v1/...`（便于后续版本化）
- 响应结构建议：`code`（业务码）、`message`、`data`、`traceId`
- 分页：`page`（1-based）、`pageSize`、返回 `total`
- 幂等：订单创建、AI 总结生成等接口使用业务唯一键（或幂等 key）避免重复

### 7.1 AI 实时对话传输约定
- 使用 SSE（Server-Sent Events）进行流式输出即可（按会话输出 `delta/done/error` 等事件）

## 8. 可观测性与安全
- 日志：结构化日志（JSON）、包含 `traceId/userId`，不记录手机号/密钥等敏感信息
- 限流：AI 对话与总结接口按用户维度限流（可用网关/Redis；MVP 可先用应用内限流但需评估多实例）
- 输入校验：所有外部输入均进行校验与错误码返回，避免注入与越权
- 密钥管理：微信/模型/支付等密钥仅通过环境变量或密钥管理系统注入

## 9. CI/CD 与部署（通用约定）

### 9.1 镜像与制品
- 每个工程提供脚本：编译 → 打包 → 构建镜像 → 推送镜像仓库
- 镜像命名建议：`<registry>/<namespace>/howtogrow-<service>:<git_sha_or_tag>`

### 9.2 生产部署（Docker Compose）
- 以 `docker compose` 部署后端与 web（MySQL 可独立部署或同编排）
- 环境变量通过 `.env` 注入（不提交密钥到仓库）

### 9.3 本地开发环境（数据库）
- 本地开发数据库连接：`localhost:3306`，账号 `root`，密码 `123456`，库名 `howtotalk`
- 本地 MySQL 启动示例：`program/deploy/docker-compose.dev.yml`
- 本地环境变量示例：`program/deploy/.env.dev.example`

## 10. 注释规范（代码与DDL）

### 10.1 代码注释（通用）
- 注释优先解释「为什么」而不是「做什么」，避免复述代码本身
- 仅在以下场景必须写注释：
  - 业务规则/决策依据（为何这样设计、为何不能那样）
  - 边界条件与不变量（输入约束、幂等前提、时区口径等）
  - 易踩坑点（并发/一致性/兼容性/外部系统限制）
  - 非直观实现（例如为了幂等、风控、限流的特殊处理）
- `TODO/FIXME` 必须说明原因与期望（可关联 issue/编号），避免“空 TODO”
- 公共 API/对外接口必须有文档注释：
  - Java：对外 Controller DTO/枚举/公共 Service 建议使用 Javadoc（参数、返回值、错误码、示例）
  - 前端：对外导出的函数/组件/类型建议用 JSDoc/TS Doc（入参、返回值、异常/边界）

### 10.2 数据库表/字段注释（DDL 规范）
> 目的：让运营/研发/数据/审计都能“脱离代码”理解数据含义，并降低后续维护成本。

- **强制要求**：所有表必须有表注释（`CREATE TABLE ... COMMENT='...'`），所有字段必须有字段注释（列定义 `... COMMENT '...'`）
- 字段注释必须包含的最小信息：
  - 业务含义（该字段代表什么）
  - 关键口径（是否含边界、单位、时间口径）
  - 枚举值（例如 `status`/`gender` 等需在注释中列出取值含义）
- 时间字段统一口径：
  - `created_at`：创建时间；`updated_at`：更新时间；`deleted_at`：软删除时间（NULL 表示未删除）
  - 支付相关：`paid_at/success_time` 统一指微信回调的支付成功时间
- 金额字段统一口径：用 `*_cent`（分），字段注释需写明“分”
- 外键/冗余字段：
  - 外键字段注释需写明“引用哪张表/哪种实体”
  - 冗余字段注释需写明“冗余目的”（例如为了查询性能/审计）
- 敏感字段（如手机号、支付回调原文等）：
  - 字段注释需标明“敏感/审计用途”，并在应用层做访问控制与日志脱敏
- DDL 管理方式：
  - `program/backend/db/schema.sql` 仅作为初始基线
  - 进入开发后建议使用迁移工具（Flyway/Liquibase），迁移脚本同样必须携带表/字段注释
