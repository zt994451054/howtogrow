<view class="page">
  <view class="status" style="height: {{statusBarHeight}}px;" />
  <view class="header row between">
    <view class="icon-btn" bindtap="openDrawer">
      <ui-icon name="menu" size="{{24}}" />
    </view>
    <view class="title">é©¬ä¸Šæ²Ÿé€š</view>
    <view class="icon-btn" bindtap="startNewChat">
      <ui-icon name="edit" size="{{22}}" />
    </view>
  </view>

  <view class="drawer-layer {{drawerOpen ? 'on' : ''}}">
    <view class="drawer-mask" bindtap="closeDrawer" />
    <view class="drawer">
      <view class="drawer__head">
        <view class="row a">
          <view class="logo">
            <view class="logo__smile" />
            <view class="logo__tail" />
          </view>
          <view class="col">
            <view class="drawer__t1">å†å²å¯¹è¯</view>
            <view class="drawer__t2">æŸ¥çœ‹ä¹‹å‰çš„å’¨è¯¢è®°å½•</view>
          </view>
        </view>
      </view>

      <scroll-view class="drawer__body" scroll-y="true" enhanced="true" show-scrollbar="false">
        <button class="new" bindtap="startNewChat">âœ å¼€å¯æ–°ä¼šè¯</button>
        <view class="tag">æœ€è¿‘</view>
        <button wx:for="{{sessions}}" wx:key="sessionId" class="sess" bindtap="selectSession" data-id="{{item.sessionId}}">
          {{item.title ? item.title : ('ä¼šè¯ #' + item.sessionId)}}
        </button>
        <view wx:if="{{sessions.length == 0}}" class="sess-empty">æš‚æ— ä¼šè¯</view>
      </scroll-view>

      <view class="drawer__foot">Howtotalk AI Assistant v1.0</view>
    </view>
  </view>

  <scroll-view
    class="messages"
    style="padding-bottom: {{bottomPadding}}px;"
    scroll-y="true"
    enhanced="true"
    show-scrollbar="false"
    scroll-into-view="{{scrollIntoId}}"
    upper-threshold="80"
    bindscrolltoupper="onMessagesScrollToUpper"
  >
    <view class="msg-list">
      <view wx:for="{{messages}}" wx:key="id" wx:for-index="idx" class="msg {{item.role == 'user' ? 'me' : 'ai'}}">
        <view class="bubble-row {{item.role == 'user' ? 'rev' : ''}}">
          <view class="avatar {{item.role == 'user' ? 'a-me' : 'a-ai'}}">
            <image
              class="avatar__img"
              src="{{item.role == 'user' ? '/assets/tab/me.png' : '/assets/logo-placeholder.png'}}"
              mode="aspectFill"
            />
          </view>
          <view wx:if="{{item.role == 'user'}}" class="bubble b-me">{{item.text}}</view>
          <view wx:else class="bubble b-ai">
            <view wx:if="{{typing && idx == messages.length - 1 && !item.text}}" class="typing-hint">
              <text>æ­£åœ¨å¸®ä½ è¾“å‡ºè§£å†³æ–¹æ¡ˆ</text>
              <view class="typing-hint__dots">
                <view class="typing-hint__dot d1" />
                <view class="typing-hint__dot d2" />
                <view class="typing-hint__dot d3" />
              </view>
            </view>
            <view wx:else class="ai-content">
              <view wx:if="{{typing && idx == messages.length - 1}}" class="ai-plain">{{item.text}}</view>
              <towxml wx:else nodes="{{item.nodes}}"></towxml>
              <view
                wx:if="{{item.text && item.id != 'm1' && (!typing || idx != messages.length - 1)}}"
                class="copy-btn"
                hover-class="copy-btn--hover"
                aria-label="copy"
                bindtap="onCopyAi"
                data-id="{{item.id}}"
              >
                <ui-icon name="copy" size="{{18}}" />
              </view>
            </view>
          </view>
        </view>

        <view wx:if="{{idx == 0 && !typing && quickQuestions.length > 0 && messages.length <= 1}}" class="quick">
          <view
            wx:for="{{quickQuestions}}"
            wx:key="*this"
            wx:for-item="qq"
            class="quick__chip"
            bindtap="onQuickQuestionTap"
            data-prompt="{{qq}}"
          >
            {{qq}}
          </view>
        </view>
      </view>

      <!-- <view wx:if="{{typing}}" class="msg ai">
        <view class="bubble-row">
          <view class="avatar a-ai"><text>ğŸ¤–</text></view>
          <view class="dots">
            <view class="dot" />
            <view class="dot" />
            <view class="dot" />
          </view>
        </view>
      </view> -->
      <view id="bottom" />
    </view>
  </scroll-view>

  <view class="input" style="bottom: {{tabbarHeight}}px;">
    <view class="ai-tip">å†…å®¹ç”±AIç”Ÿæˆ,ä»…ä¾›å‚è€ƒ</view>
    <view class="box row">
      <input class="ipt" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." value="{{input}}" bindinput="onInput" confirm-type="send" bindconfirm="onSend" />
      <view class="send {{inputTrim ? 'on' : 'off'}}" bindtap="onSend">â¤</view>
    </view>
  </view>
  <auth-modal show="{{showAuthModal}}" bind:success="onAuthSuccess" />
</view>
