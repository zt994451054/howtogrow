<view class="page">
  <view class="status" style="height: {{statusBarHeight}}px;" />

  <!-- 顶部参考「每日觉察」页面：头像问候 + 菜单 -->
  <view class="header row between" style="padding-top: {{headerPadTopPx}}px;">
    <view class="row a">
      <view class="avatar" bindtap="onOpenProfile" hover-class="tap" hover-stay-time="80">
        <image wx:if="{{avatarUrl}}" class="avatar__img" src="{{avatarUrl}}" mode="aspectFill" />
        <view wx:else class="avatar__text">{{avatarText}}</view>
      </view>
      <view class="col">
        <view class="greet">{{greetText}}</view>
      </view>
    </view>
    <view class="icon-btn" bindtap="toggleChildMenu">
      <ui-icon name="menu" size="{{24}}" />
    </view>
  </view>

  <view wx:if="{{menuOpen}}" class="menu-layer">
    <view class="menu-mask" bindtap="closeChildMenu" />
    <view class="menu-pop" style="top: {{menuPopoverTopPx}}px;">
      <view class="menu-pop__title">切换孩子</view>
      <view class="menu-pop__list">
        <button
          wx:for="{{children}}"
          wx:key="id"
          class="menu-item {{selectedChildId == item.id ? 'on' : ''}}"
          bindtap="onPickChild"
          data-id="{{item.id}}"
        >
          <view class="menu-item__row row between">
            <view class="menu-item__name">{{item.nickname}}</view>
            <view wx:if="{{selectedChildId == item.id}}" class="menu-item__dot" />
          </view>
        </button>
        <button class="menu-item add" bindtap="onAddChild">＋ 添加新孩子</button>
      </view>
    </view>
  </view>

  <!-- 使用页面原生滚动：避免 canvas 在 scroll-view 中随滚动出现抖动/漂浮 -->
  <view class="body safe-bottom">
    <view wx:if="{{!childrenLoaded}}" class="loading">加载中…</view>

    <view wx:elif="{{children.length == 0}}" class="empty col center">
      <view class="empty__logo">
        <view class="logo-dot">
          <view class="logo-smile" />
          <view class="logo-tail" />
        </view>
      </view>
      <view class="empty__title">还没有添加孩子</view>
      <view class="empty__desc">添加孩子信息后\n即可开启家长曲线</view>
      <button class="btn-primary" bindtap="onAddChild">添加孩子</button>
    </view>

    <view wx:else class="wrap">
      <view class="section-head row between">
        <view class="section-head__title">我的成长曲线</view>
        <view class="date-chip row a" bindtap="onPickDateRange">
          <ui-icon name="calendar" size="{{10}}" />
          <view class="date-chip__text">{{rangeLabel}}</view>
          <image src='../../assets/image/uni-down.png' style='width: 14px;height: 14px;'/>
          <!-- <ui-icon name="chevronDown" size="{{14}}"/> -->
        </view>
      </view>

      <view class="chart-card">
        <view wx:if="{{!customRangeOpen}}">
          <ec-canvas
            id="parentCurveChart"
            style="display: block; width: 100%; height: 520rpx;"
            canvas-id="parentCurveChart"
            ec="{{ec}}"
            bind:init="onEcInit"
          />
          <view wx:if="{{chartEmpty}}" class="chart-empty col center">
            <view class="chart-empty__t1">暂无数据</view>
            <view class="chart-empty__t2">完成每日自测后，可查看 5 大维度的趋势变化</view>
            <button class="chart-empty__btn" bindtap="goTest">去测评</button>
          </view>
        </view>
      </view>

      <view class="dim-pills">
        <button
          wx:for="{{dimensions}}"
          wx:key="code"
          class="dim-pill {{item._on ? 'on' : 'off'}}"
          style="background: {{item._on ? item.bg : '#E7E7E7'}};"
          bindtap="onToggleDimension"
          data-code="{{item.code}}"
        >
          <text class="dim-pill__text">{{item.label}}</text>
        </button>
      </view>

      <view class="persist col center" wx:if="{{false}}">
        <view class="persist__icon">
          <image src='https://picsum.photos/seed/picsum/300/300'/>
        </view>
        <view class="persist__name">{{progressName}}</view>
        <view class="persist__desc">
          在此期间坚持进步了 <text class="persist__num">{{persistenceDays}}</text> 天
        </view>
        <view class="persist__hint">你的每次觉察，都是孩子成长路上最珍贵的礼物</view>
      </view>

      <view class="mood-card">
        <view class="mood-card__head col center">
          <view class="mood-card__title">我的育儿状态分布</view>
          <view class="mood-card__sub">已记录 {{statusTotalDays}} 天</view>
        </view>

        <view class="mood-row">
          <view wx:for="{{statusStatsTop}}" wx:key="moodId" class="mood-row__item">
            <view class="mood-row__face" style="background: {{item.color}};">
              <image wx:if="{{item.imageUrl}}" class="mood-row__img" src="{{item.imageUrl}}" mode="aspectFill" lazy-load="{{true}}" />
              <view wx:else class="mood-row__emoji">{{item.emoji}}</view>
            </view>
            <view class="mood-row__pill">
              <text class="mood-row__pct" style="color: {{item.color}};">{{item.percentage}}%</text>
            </view>
          </view>
        </view>

        <view class="mood-stack">
          <view wx:if="{{statusTotalDays > 0}}" class="mood-stack__bar">
            <view
              wx:for="{{statusStatsTop}}"
              wx:key="moodId"
              class="mood-stack__seg {{index === 0 ? 'first' : ''}} {{index === statusStatsTopLastIndex ? 'last' : ''}}"
              style="flex: {{item.count}} 0 0; background: {{item.color}};"
            />
          </view>
          <view wx:else class="mood-stack__bar empty" />
        </view>
      </view>

      <view class="section row between">
        <view class="section__title">我的困扰分布</view>
        <view class="more row a" bindtap="goTroubles">
          <view class="more__text">更多</view>
          <view class="more__icon">›</view>
        </view>
      </view>

      <view wx:if="{{troubleLoading}}" class="loading">加载中…</view>
      <view wx:elif="{{topTroubles.length == 0}}" class="trouble-empty">暂无数据</view>
      <view wx:else class="troubles">
        <view wx:for="{{topTroubles}}" wx:key="rank" class="trouble">
          <view class="trouble__rank">{{item.rank}}</view>
          <view class="trouble__icon">
            <image wx:if="{{item.logoUrl}}" class="trouble__img" src="{{item.logoUrl}}" mode="aspectFill" />
            <view wx:else class="trouble__fallback">{{item.shortName}}</view>
          </view>
          <view class="trouble__name">{{item.name}}</view>
        </view>
      </view>

      <view class="footer-hint"><text class="def">困扰您最多的是</text><text class="gra">动不动哭闹发脾气</text></view>
    </view>
  </view>

  <!-- 自定义日期范围（最多180天） -->
  <view class="sheet {{customRangeOpen ? 'show' : ''}}">
    <view class="sheet__mask" bindtap="closeCustomRangePicker" />
    <view class="sheet__panel">
      <view class="sheet__head row between">
        <view class="sheet__title">自定义日期范围</view>
        <view class="sheet__close" bindtap="closeCustomRangePicker">×</view>
      </view>
      <view class="sheet__sub">最多180天，超出将自动调整</view>

      <view class="range-form">
        <view class="range-field">
          <view class="range-field__label">开始日期</view>
          <picker
            mode="date"
            value="{{customFromDraft}}"
            start="{{customMinDate}}"
            end="{{today}}"
            bindchange="onCustomFromChange"
          >
            <view class="range-field__value row between">
              <view>{{customFromDraft}}</view>
              <view class="range-field__arrow">›</view>
            </view>
          </picker>
        </view>

        <view class="range-field">
          <view class="range-field__label">结束日期</view>
          <picker
            mode="date"
            value="{{customToDraft}}"
            start="{{customMinDate}}"
            end="{{today}}"
            bindchange="onCustomToChange"
          >
            <view class="range-field__value row between">
              <view>{{customToDraft}}</view>
              <view class="range-field__arrow">›</view>
            </view>
          </picker>
        </view>
      </view>

      <view class="range-hint">共 {{customRangeDays}} 天</view>

      <view class="range-actions row">
        <button class="range-btn ghost" bindtap="closeCustomRangePicker">取消</button>
        <button class="range-btn primary" bindtap="onCustomRangeConfirm">确认</button>
      </view>
    </view>
  </view>
</view>
