# 微信小程序端技术方案（Howtotalk 家长端）

> 本文件是小程序端实现的**统一依据**：必须与 `program/backend/API.md` 保持一致；UI/交互以 `效果图/` 与 `program/miniprogram/howtotalk/`（Web 原型）为还原目标。
>
> 强约束：
> - UI 与交互必须高度还原（优先级最高）。
> - 先完成本技术方案评审通过，再开始编码（避免返工）。

## 0. 范围与目标

覆盖功能（家长端）：
- 登录
- 首页：鸡汤语、产品介绍、课程卡片
- 每日自测：选孩子 → 开始 → 答题（换题）→ 提交 → 结果页 →（可选）AI 总结
- 马上沟通：AI 实时对话（会话列表/抽屉 + 当前会话）
- 我的：用户信息、孩子管理、自测记录/详情、成长报告、订阅管理、用户协议

非目标（本期不做或后置）：
- 多端复用（先把小程序跑稳、还原到位）
- 复杂动效/皮肤系统（除必要的淡入/过渡）
- 运营配置后台（由后端/管理端另行负责）

## 1. 技术选型（以简单高效为准）

### 1.1 客户端
- 原生微信小程序 + JavaScript（页面/组件少而清晰；避免 TypeScript 编译链/依赖分析导致的 “找不到 index.js” 类踩坑）
- UI：不引入重 UI 组件库（避免“长得不像”），自研少量基础组件以保证高度还原
- 图表：小程序 ECharts 适配（`ec-canvas` 类方案），用于成长报告折线图

### 1.2 后端契约
- API 前缀：`/api/v1`（以 `program/backend/API.md` 为准）
- 统一响应：`ApiResponse<T>`（包含 `code/message/data/traceId` 等）
- 错误码需按文档处理：`SUBSCRIPTION_REQUIRED`、`FREE_TRIAL_ALREADY_USED`、`DAILY_ASSESSMENT_ALREADY_SUBMITTED`、`DAILY_ASSESSMENT_INCOMPLETE`、`QUESTION_POOL_EXHAUSTED`、`AI_SUMMARY_ALREADY_GENERATED`、`RATE_LIMITED` 等

## 2. 工程结构

> 当前小程序工程已落地在 `program/miniprogram/app/`。微信开发者工具可：
> - 直接打开 `program/miniprogram/`（`miniprogramRoot=app/`）
> - 或打开 `program/miniprogram/app/`

结构如下：
- `program/miniprogram/app/app.json` / `app.js` / `app.wxss`
- `program/miniprogram/app/pages/`（页面）
- `program/miniprogram/app/components/`（基础组件）
- `program/miniprogram/app/services/`（网络层、API client、鉴权）
- `program/miniprogram/app/styles/`（设计 token、通用样式）
- `program/miniprogram/app/assets/`（包内静态资源：logo、tab 图标、少量插画）

## 3. 页面与路由设计（Tab + 子页面）

### 3.1 底部 Tab（一级）
对齐 Web 原型的 `activeTab`（`program/miniprogram/howtotalk/App.tsx:1`）：
- 首页：`home`
- 每日自测：`test`
- 马上沟通：`chat`
- 我的：`me`

### 3.2 子页面拆分（避免“一个页面堆状态机”）
把 Web 里的 overlay/内部 view 拆成独立 page，利于复刻交互与维护：
- 每日自测：
  - `test/index`：孩子选择（对应 Web `selection`）
  - `test/intro`：开始页（对应 Web `intro`）
  - `test/question`：答题页（对应 Web `active`，整屏覆盖效果）
  - `test/result`：结果页（对应 Web `result`，整屏覆盖效果）
- 马上沟通：
  - `chat/index`：会话 + 抽屉历史（对齐 Web `ChatInterface.tsx`）
- 我的：
  - `me/index`：主页面菜单
  - `me/children`：孩子管理（增删改）
  - `me/history`：自测记录列表
  - `me/history-detail`：记录详情（复用结果页 UI）
  - `me/growth-report`：成长报告（折线图）
  - `me/subscription`：订阅管理（套餐选择/支付）
  - `me/agreement`：用户协议

### 3.3 跨 Tab “带参数跳转”
Web 原型通过 `navParams` 在 Tab 间传递（`program/miniprogram/howtotalk/App.tsx:1`）。小程序 `switchTab` 不支持 query，采用一次性参数存储：
- 发送方：`wx.setStorageSync('nav:me', { view: 'children', action: 'add' })` + `wx.switchTab({ url: '/pages/me/index' })`
- 接收方：`me/index` 的 `onShow` 读取并消费后立刻清理

## 4. UI/交互高度还原：设计系统与基础组件

### 4.1 设计 token（先收敛再铺开）
从 Web 原型提取高频视觉要素（橙色主色 + 灰阶 + 圆角 + 阴影 + 间距/字号），落在 `styles/` 中：
- 颜色：主色（orange）、强调色、灰阶文本、背景浅粉（结果页背景）、分割线灰
- 圆角：12/16/24/999（卡片、按钮、标签、胶囊输入框）
- 阴影：轻阴影（卡片）、按钮投影（主按钮）
- 排版：标题/正文/辅助字（对齐效果图字号层级）

### 4.2 基础组件（自研、少量、稳定）
为复刻交互，建议先实现：
- `TabBar`：底部固定，激活态橙色（对齐 `program/miniprogram/howtotalk/components/TabBar.tsx:1`）
- `Header`：顶部标题栏（含返回/关闭按钮）
- `Button`：主按钮/次按钮/禁用态（尤其答题页 Next 禁用态）
- `Card`：统一卡片容器（圆角+阴影）
- `Drawer`：聊天历史抽屉（遮罩 + 左侧滑出）

## 5. 数据与状态（最小可用）

### 5.1 本地存储 key（建议）
- `auth:token`：JWT
- `user:me`：`/api/v1/miniprogram/me` 缓存（可选）
- `children:list`：孩子列表缓存（可选，真实以服务端为准）
- `daily:session`：当前自测会话 `{ sessionId, questions, answers, startedAt }`
- `chat:activeSessionId`：当前会话

### 5.2 页面状态原则
- 业务状态尽量来自 API（题目、换题、订阅状态、报告数据）
- UI 状态留在页面内部（抽屉开关、输入框、加载中、toast）

## 6. 网络层与鉴权（必须稳定）

### 6.1 Base URL
- 小程序端配置 `API_BASE_URL`（开发/生产可切换）
- 只拼接路径 `/api/v1/...`，避免页面里散落 URL 字符串

### 6.2 request 封装
统一封装：
- 自动注入 `Authorization: Bearer <token>`
- 统一超时、错误提示、重试策略（仅对幂等 GET 做有限重试）
- 统一错误码分流：
  - `UNAUTHORIZED`：清 token → 重新登录
  - `SUBSCRIPTION_REQUIRED` / `FREE_TRIAL_ALREADY_USED`：引导去订阅页
  - `RATE_LIMITED`：提示稍后重试

### 6.3 JWT 保存策略（小程序无 Cookie）
- Token 使用 `wx.setStorageSync('auth:token', token)` 持久化（跨会话保留）
- 每次进入小程序（或冷启动）优先用本地 token 调 `GET /me` 校验有效性；若 401 则自动走 `wx.login` → `/wechat-login` 刷新 token

### 6.4 资料补全（头像/昵称）与头像上传
目标：小程序启动时静默登录；在敏感操作（发消息、添加孩子等）前，要求用户完善头像与昵称。

关键点：`open-type="chooseAvatar"` 只能拿到本地临时路径，必须先上传到后端，拿到可访问 URL，再提交资料更新。

流程：
1. 触发受保护操作 → 检查 `me.nickname/me.avatarUrl` 是否完整
2. 不完整 → 弹出底部 `auth-modal`（头像 + 昵称）
3. 选择头像 → 拿到临时路径 `wxfile://...`
4. `wx.uploadFile` → `POST /api/v1/miniprogram/uploads/avatar`（`multipart/form-data`，字段 `file`）→ 返回 `{ url }`
5. `POST /api/v1/miniprogram/me/profile` 保存 `{ nickname, avatarUrl: url }`

后端存储：上传接口将文件上传至阿里云 OSS，并返回 URL（生产环境建议 OSS + CDN，且对象需可被小程序访问）。

## 7. API 对齐清单（以 `program/backend/API.md` 为准）

### 7.1 登录与用户
- `POST /api/v1/miniprogram/auth/wechat-login`：`wx.login()` 换 JWT
- `GET /api/v1/miniprogram/me`：获取用户信息/订阅状态（若响应包含）
- `POST /api/v1/miniprogram/uploads/avatar`：上传头像（返回 URL）
- `POST /api/v1/miniprogram/me/profile`：保存昵称与头像 URL

### 7.2 孩子
- `GET /api/v1/miniprogram/children`
- `POST /api/v1/miniprogram/children`
- `PUT /api/v1/miniprogram/children/{childId}`
- `DELETE /api/v1/miniprogram/children/{childId}`

### 7.3 首页
- `GET /api/v1/miniprogram/quotes/random`：随机鸡汤语

### 7.4 每日自测（会话式）
- `POST /api/v1/miniprogram/assessments/daily/begin`：开始（不落库）→ 返回 `sessionId + questions`
- `POST /api/v1/miniprogram/assessments/daily/sessions/{sessionId}/replace`：换题（后端裁决）
- `POST /api/v1/miniprogram/assessments/daily/sessions/{sessionId}/submit`：一次性提交并落库
- `POST /api/v1/miniprogram/assessments/daily/{assessmentId}/ai-summary`：生成 AI 总结（可选）

### 7.5 马上沟通（会话 + SSE）
- `POST /api/v1/miniprogram/ai/chat/sessions`：创建会话
- `GET /api/v1/miniprogram/ai/chat/sessions?limit=20`：会话列表
- `POST /api/v1/miniprogram/ai/chat/sessions/{sessionId}/messages`：发送消息
- `GET /api/v1/miniprogram/ai/chat/sessions/{sessionId}/stream`：SSE 流式回复（事件：`delta/done/error`）

### 7.6 成长报告
- `GET /api/v1/miniprogram/reports/growth?childId=...&from=yyyy-MM-dd&to=yyyy-MM-dd`

### 7.7 订阅
- `GET /api/v1/miniprogram/subscriptions/plans`：套餐列表
- `POST /api/v1/miniprogram/subscriptions/orders`：创建订单并返回 `payParams`
- `wx.requestPayment(payParams)`：发起支付（最终以服务端回调更新订阅为准）

## 8. 每日自测：交互与异常处理（按效果图还原）

核心原则：
- 前端负责“体验流程”，后端负责“安全裁决”（是否已提交/是否可免费体验/是否需要订阅）
- 题目与换题由后端决定；前端不做随机题库逻辑

页面交互要点：
- 孩子选择页：无孩子时显示空态，引导去“孩子管理”新增
- 答题页：
  - 顶部进度条（题号/进度百分比）
  - 选项卡片选中态/未选中态严格对齐效果图
  - 未选择时 Next 按钮禁用
  - “换个题目”按钮触发 replace
- 提交流程：
  - 必须完整作答后才允许 submit
  - submit 返回后进入结果页；结果页支持“返回/完成”

## 9. 马上沟通：SSE 与降级策略

目标：
- 优先做到“边生成边显示”（流式/准流式）
- 若运行环境不支持分块回调，则不强制流式，保证可用性与体验一致

实现策略：
- 首选：`wx.request` 开启分块（如 `enableChunked`）并按 SSE 协议解析 `delta/done/error`
- 降级 1：无法拿到 chunk，但能拿到完整响应体 → 等待结束后一次性渲染（表现为“假流式”但可用）
- 降级 2：若基础库/网络栈无法处理 `text/event-stream` → 后端需要提供非流式接口（本期先不强依赖；若触发此问题再评估补接口）

## 10. 静态资源与对象存储（你后续补齐即可）

### 10.1 需要的静态资源清单
- 品牌资源：App logo、启动图（可选）
- TabBar 图标：首页/自测/沟通/我的（选中态可用变色或两套资源）
- 常用 UI 图标：返回/关闭/日历/箭头/警告/对勾等（可优先用 iconfont 或少量 png）
- 首页课程封面图：课程卡片的背景图（生产需替换掉占位图）
- 默认头像/插画：用户头像占位、空态插画（可选但建议有）

### 10.2 放包内 vs 放远端（对象存储/CDN）
- 放包内（推荐）：logo、Tab 图标、少量关键 UI 图标、少量空态插画（保证弱网可用）
- 放远端（推荐）：课程封面、较大插画、可运营替换的图片（避免包体膨胀）

### 10.3 远端资源的必备条件
- 必须 HTTPS
- 小程序后台需配置合法域名（根据实际托管域名配置：request/download/upload/socket）
- 资源建议走 CDN，开启缓存（减少加载时间与带宽）

## 11. 开发与验收（你自行运行验收）

验收方式：
- 你用微信开发者工具/真机运行，对照 `效果图/`（首页/答题过程/答题完毕/成长报告）逐项确认

里程碑建议（降低返工）：
1. UI 纯前端还原（用 mock 数据），先把 4 张效果图“长得一样”
2. 接入后端 API（登录/孩子/自测/报告/订阅）
3. 接入 AI 对话（先可用，再尝试流式，失败则降级）

## 12. 决策与风险（提前写清楚）
- SSE 流式在小程序侧是否“真流式”依赖基础库与机型：方案按“可流则流、不可则降级”落地
- 成长报告折线图依赖小程序 ECharts 适配：若兼容性差，备用方案是改为服务端出图或换更轻量的 canvas 图表库
